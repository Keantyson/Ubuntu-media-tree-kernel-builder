From 218023a80d73887e9e4a094a488fdacdbaf540d7 Mon Sep 17 00:00:00 2001
From: root <hidden@email.co>
Date: Tue, 21 Nov 2017 21:33:29 +0000
Subject: [PATCH 02/25] em28xx: bulk transfer implementation fix

 Set appropriate bulk/ISOC transfer size on capture start
---
 drivers/media/usb/em28xx/em28xx-core.c | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/drivers/media/usb/em28xx/em28xx-core.c b/drivers/media/usb/em28xx/em28xx-core.c
index 08b539f0345e..2beba91363ae 100644
--- a/drivers/media/usb/em28xx/em28xx-core.c
+++ b/drivers/media/usb/em28xx/em28xx-core.c
@@ -639,6 +639,17 @@ int em28xx_capture_start(struct em28xx *dev, int start)
 	    dev->chip_id == CHIP_ID_EM28178) {
 		/* The Transport Stream Enable Register moved in em2874 */
 		if (dev->board.has_dual_ts) {
+			if (dev->dvb_xfer_bulk) {
+				/* Max Tx Size = 188 * EM28XX_DVB_BULK_PACKET_MULTIPLIER */
+				em28xx_write_reg(dev, (dev->ts == PRIMARY_TS) ?
+						EM2874_R5D_TS1_PKT_SIZE :
+						EM2874_R5E_TS2_PKT_SIZE, 0xef);
+			} else {
+				/* TS2 Maximum Transfer Size = 188 * 5 */
+				em28xx_write_reg(dev, (dev->ts == PRIMARY_TS) ?
+						EM2874_R5D_TS1_PKT_SIZE :
+						EM2874_R5E_TS2_PKT_SIZE, 0x05);
+			}
 			if (dev->ts == PRIMARY_TS)
 				rc = em28xx_write_reg_bits(dev, EM2874_R5F_TS_ENABLE,
 						start ?
@@ -650,6 +661,13 @@ int em28xx_capture_start(struct em28xx *dev, int start)
 						EM2874_TS2_CAPTURE_ENABLE : 0x00,
 						EM2874_TS2_CAPTURE_ENABLE);
 		} else {
+			if (dev->dvb_xfer_bulk) {
+				/* Max Tx Size = 188 * EM28XX_DVB_BULK_PACKET_MULTIPLIER */
+				em28xx_write_reg(dev, EM2874_R5D_TS1_PKT_SIZE, 0xef);
+			} else {
+				/* TS1 Maximum Transfer Size = 188 * 5 */
+				em28xx_write_reg(dev, EM2874_R5D_TS1_PKT_SIZE, 0x05);
+			}
 			rc = em28xx_write_reg_bits(dev, EM2874_R5F_TS_ENABLE,
 					start ?
 					EM2874_TS1_CAPTURE_ENABLE : 0x00,
-- 
2.11.0

