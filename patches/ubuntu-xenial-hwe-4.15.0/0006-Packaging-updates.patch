From ee201491e4a42364183bcf04a466e3d9046e161e Mon Sep 17 00:00:00 2001
From: Brad Love <hidden@email.co>
Date: Mon, 5 Aug 2019 13:17:36 -0500
Subject: [PATCH 6/6] Packaging updates

---
 debian.hwe/control.d/flavour-control.stub | 32 +++++++++++++--------------
 debian.hwe/control.stub.in                | 36 ++++++-------------------------
 debian.hwe/copyright                      | 22 +++++++++++++++++++
 debian.hwe/rules.d/amd64.mk               | 20 ++++++++---------
 debian.hwe/rules.d/arm64.mk               |  8 +++----
 debian.hwe/rules.d/armhf.mk               |  8 +++----
 debian.hwe/rules.d/i386.mk                | 12 +++++------
 debian.hwe/rules.d/ppc64el.mk             | 10 ++++-----
 debian.hwe/rules.d/s390x.mk               |  8 +++----
 debian.hwe/rules.d/x32.mk                 |  2 +-
 debian.master/rules.d/hooks.mk            |  5 +++++
 debian/control.d/flavour-buildinfo.stub   |  2 +-
 debian/rules                              |  2 +-
 debian/rules.d/0-common-vars.mk           | 29 ++++++++++++++++---------
 debian/rules.d/2-binary-arch.mk           |  4 ++++
 debian/scripts/dkms-build                 |  2 +-
 16 files changed, 110 insertions(+), 92 deletions(-)
 create mode 100644 debian.master/rules.d/hooks.mk

diff --git a/debian.hwe/control.d/flavour-control.stub b/debian.hwe/control.d/flavour-control.stub
index c172159..315df5e 100644
--- a/debian.hwe/control.d/flavour-control.stub
+++ b/debian.hwe/control.d/flavour-control.stub
@@ -21,17 +21,17 @@
 #
 # XXX: Leave the blank line before the first package!!
 
-Package: linux-image=SIGN-ME-PKG=-PKGVER-ABINUM-FLAVOUR
+Package: linux-image-mediatree=SIGN-ME-PKG=-PKGVER-ABINUM-FLAVOUR
 Build-Profiles: <!stage1>
 Architecture: ARCH
 Section: kernel
 Priority: optional
 Provides: linux-image, fuse-module, aufs-dkms, =PROVIDES=${linux:rprovides}
-Depends: ${misc:Depends}, ${shlibs:Depends}, kmod, linux-base (>= 4.5ubuntu1~16.04.1), linux-modules-PKGVER-ABINUM-FLAVOUR
+Depends: ${misc:Depends}, ${shlibs:Depends}, kmod, linux-base (>= 4.5ubuntu1~16.04.1), linux-modules-mediatree-PKGVER-ABINUM-FLAVOUR
 Recommends: BOOTLOADER, initramfs-tools | linux-initramfs-tool
 Breaks: flash-kernel (<< 3.0~rc.4ubuntu62.2) [arm64], s390-tools (<< 1.34.0-0ubuntu8.6) [s390x]
-Conflicts: linux-image=SIGN-PEER-PKG=-PKGVER-ABINUM-FLAVOUR
-Suggests: fdutils, SRCPKGNAME-tools, linux-headers-PKGVER-ABINUM-FLAVOUR
+Conflicts: linux-image-mediatree=SIGN-PEER-PKG=-PKGVER-ABINUM-FLAVOUR
+Suggests: fdutils, SRCPKGNAME-tools, linux-headers-mediatree-PKGVER-ABINUM-FLAVOUR
 Description: Linux kernel image for version PKGVER on DESC
  This package contains the=SIGN-ME-TXT= Linux kernel image for version PKGVER on
  DESC.
@@ -44,7 +44,7 @@ Description: Linux kernel image for version PKGVER on DESC
  the linux-FLAVOUR meta-package, which will ensure that upgrades work
  correctly, and that supporting packages are also installed.
 
-Package: linux-modules-PKGVER-ABINUM-FLAVOUR
+Package: linux-modules-mediatree-PKGVER-ABINUM-FLAVOUR
 Build-Profiles: <!stage1>
 Architecture: ARCH
 Section: kernel
@@ -63,13 +63,13 @@ Description: Linux kernel extra modules for version PKGVER on DESC
  the linux-FLAVOUR meta-package, which will ensure that upgrades work
  correctly, and that supporting packages are also installed.
 
-Package: linux-modules-extra-PKGVER-ABINUM-FLAVOUR
+Package: linux-modules-extra-mediatree-PKGVER-ABINUM-FLAVOUR
 Build-Profiles: <!stage1>
 Architecture: ARCH
 Section: kernel
 Priority: optional
-Depends: ${misc:Depends}, ${shlibs:Depends}, linux-image-PKGVER-ABINUM-FLAVOUR | linux-image-unsigned-PKGVER-ABINUM-FLAVOUR, crda | wireless-crda
-Description: Linux kernel extra modules for version PKGVER on DESC
+Depends: ${misc:Depends}, ${shlibs:Depends}, linux-image-mediatree-PKGVER-ABINUM-FLAVOUR | linux-image-mediatree-unsigned-PKGVER-ABINUM-FLAVOUR, crda | wireless-crda
+Description: Linux kernel extra modules with slipstreamed mediatree drivers for version PKGVER on DESC
  This package contains the Linux kernel extra modules for version PKGVER on
  DESC.
  .
@@ -85,21 +85,21 @@ Description: Linux kernel extra modules for version PKGVER on DESC
  the linux-FLAVOUR meta-package, which will ensure that upgrades work
  correctly, and that supporting packages are also installed.
 
-Package: linux-headers-PKGVER-ABINUM-FLAVOUR
+Package: linux-headers-mediatree-PKGVER-ABINUM-FLAVOUR
 Build-Profiles: <!stage1>
 Architecture: ARCH
 Section: devel
 Priority: optional
-Depends: ${misc:Depends}, linux-headers-PKGVER-ABINUM, ${shlibs:Depends}
+Depends: ${misc:Depends}, linux-headers-mediatree-PKGVER-ABINUM, ${shlibs:Depends}
 Provides: linux-headers, linux-headers-3.0
-Description: Linux kernel headers for version PKGVER on DESC
+Description: Linux kernel headers with slipstreamed mediatree drivers for version PKGVER on DESC
  This package provides kernel header files for version PKGVER on
  DESC.
  .
  This is for sites that want the latest kernel headers.  Please read
  /usr/share/doc/linux-headers-PKGVER-ABINUM/debian.README.gz for details.
 
-Package: linux-image=SIGN-ME-PKG=-PKGVER-ABINUM-FLAVOUR-dbgsym
+Package: linux-image-mediatree=SIGN-ME-PKG=-PKGVER-ABINUM-FLAVOUR-dbgsym
 Build-Profiles: <!stage1>
 Architecture: ARCH
 Section: devel
@@ -116,24 +116,24 @@ Description: Linux kernel debug image for version PKGVER on DESC
  is uncompressed, and unstripped. This package also includes the
  unstripped modules.
 
-Package: linux-tools-PKGVER-ABINUM-FLAVOUR
+Package: linux-tools-mediatree-PKGVER-ABINUM-FLAVOUR
 Build-Profiles: <!stage1>
 Architecture: ARCH
 Section: devel
 Priority: optional
-Depends: ${misc:Depends}, SRCPKGNAME-tools-PKGVER-ABINUM
+Depends: ${misc:Depends}, SRCPKGNAME-tools-mediatree-PKGVER-ABINUM
 Description: Linux kernel version specific tools for version PKGVER-ABINUM
  This package provides the architecture dependant parts for kernel
  version locked tools (such as perf and x86_energy_perf_policy) for
  version PKGVER-ABINUM on
  =HUMAN=.
 
-Package: linux-cloud-tools-PKGVER-ABINUM-FLAVOUR
+Package: linux-cloud-tools-mediatree-PKGVER-ABINUM-FLAVOUR
 Build-Profiles: <!stage1>
 Architecture: ARCH
 Section: devel
 Priority: optional
-Depends: ${misc:Depends}, SRCPKGNAME-cloud-tools-PKGVER-ABINUM
+Depends: ${misc:Depends}, SRCPKGNAME-cloud-tools-mediatree-PKGVER-ABINUM
 Description: Linux kernel version specific cloud tools for version PKGVER-ABINUM
  This package provides the architecture dependant parts for kernel
  version locked tools for cloud for version PKGVER-ABINUM on
diff --git a/debian.hwe/control.stub.in b/debian.hwe/control.stub.in
index fd7fa38..f4ae136 100644
--- a/debian.hwe/control.stub.in
+++ b/debian.hwe/control.stub.in
@@ -1,7 +1,8 @@
 Source: SRCPKGNAME
 Section: devel
 Priority: optional
-Maintainer: Ubuntu Kernel Team <kernel-team@lists.ubuntu.com>
+Maintainer: Fake User <hidden@email.co>
+XSBC-Original-Maintainer: Ubuntu Kernel Team <kernel-team@lists.ubuntu.com>
 Standards-Version: 3.9.4.0
 Build-Depends:
  debhelper (>= 9),
@@ -48,35 +49,12 @@ Build-Depends-Indep:
  asciidoc <!stage1>,
  python-sphinx <!stage1>,
  python-sphinx-rtd-theme <!stage1>,
-Vcs-Git: git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/xenial -b hwe
+Vcs-Git: git://github.com/~b-rad-NDi/Ubuntu-media-tree-kernel-builder.git
+Vcs-Browser: https://github.com/b-rad-NDi/Ubuntu-media-tree-kernel-builder
 XS-Testsuite: autopkgtest
 #XS-Testsuite-Depends: gcc-4.7 binutils
 
-Package: linux-source-PKGVER
-Build-Profiles: <!stage1>
-Architecture: all
-Section: devel
-Priority: optional
-Provides: linux-source, linux-source-3
-Depends: ${misc:Depends}, binutils, bzip2, coreutils
-Recommends: libc-dev, gcc, make
-Suggests: libncurses-dev | ncurses-dev, kernel-package, libqt3-dev
-Description: Linux kernel source for version PKGVER with Ubuntu patches
- This package provides the source code for the Linux kernel version
- PKGVER.
- .
- This package is mainly meant for other packages to use, in order to build
- custom flavours.
- .
- If you wish to use this package to create a custom Linux kernel, then it
- is suggested that you investigate the package kernel-package, which has
- been designed to ease the task of creating kernel image packages.
- .
- If you are simply trying to build third-party modules for your kernel,
- you do not want this package. Install the appropriate linux-headers
- package instead.
-
-Package: linux-headers-PKGVER-ABINUM
+Package: linux-headers-mediatree-PKGVER-ABINUM
 Build-Profiles: <!stage1>
 Architecture: all
 Multi-Arch: foreign
@@ -88,7 +66,7 @@ Description: Header files related to Linux kernel version PKGVER
  that want the latest kernel headers. Please read
  /usr/share/doc/SRCPKGNAME-headers-PKGVER-ABINUM/debian.README.gz for details
 
-Package: SRCPKGNAME-tools-PKGVER-ABINUM
+Package: SRCPKGNAME-tools-mediatree-PKGVER-ABINUM
 Build-Profiles: <!stage1>
 Architecture: i386 amd64 armhf arm64 ppc64el s390x
 Section: devel
@@ -101,7 +79,7 @@ Description: Linux kernel version specific tools for version PKGVER-ABINUM
  =HUMAN=.
  You probably want to install linux-tools-PKGVER-ABINUM-<flavour>.
 
-Package: SRCPKGNAME-cloud-tools-PKGVER-ABINUM
+Package: SRCPKGNAME-cloud-tools-mediatree-PKGVER-ABINUM
 Build-Profiles: <!stage1>
 Architecture: i386 amd64 armhf
 Section: devel
diff --git a/debian.hwe/copyright b/debian.hwe/copyright
index d1d04a6..b6f183f 100644
--- a/debian.hwe/copyright
+++ b/debian.hwe/copyright
@@ -1,3 +1,25 @@
+#############################################################
+#############################################################
+#############################################################
+
+This is a patched version of the Ubuntu kernel.
+The latest media tree drivers from https://linuxtv.org are slip streamed in.
+
+Additional patches for hardware/performance/etc are also included.
+
+All patches are available at https://github.com/b-rad-NDi/Ubuntu-media-tree-kernel-builder
+
+The packaging and build system is spoonsored by Hauppauge Computer Works.
+
+    http://www.hauppauge.com
+
+Errors in packaging or building should be directed to github above.
+Bugs in the kernel or media tree drivers should be reported upstream.
+
+#############################################################
+#############################################################
+#############################################################
+
 This is the Ubuntu prepackaged version of the Linux kernel.
 Linux was written by Linus Torvalds <Linus.Torvalds@cs.Helsinki.FI>
 and others.
diff --git a/debian.hwe/rules.d/amd64.mk b/debian.hwe/rules.d/amd64.mk
index 4046adf..6784752 100644
--- a/debian.hwe/rules.d/amd64.mk
+++ b/debian.hwe/rules.d/amd64.mk
@@ -9,16 +9,16 @@ install_file	= vmlinuz
 loader		= grub
 vdso		= vdso_install
 no_dumpfile	= true
-uefi_signed     = true
-do_tools_usbip  = true
-do_tools_cpupower = true
-do_tools_perf   = true
-do_tools_perf_jvmti = true
-do_tools_x86	= true
-do_tools_hyperv	= true
-do_tools_host = true
+uefi_signed     = false
+do_tools_usbip  = false
+do_tools_cpupower = false
+do_tools_perf   = false
+do_tools_perf_jvmti = false
+do_tools_x86	= false
+do_tools_hyperv	= false
+do_tools_host = false
 do_extras_package = true
-do_tools_common = true
-do_tools_acpidbg = true
+do_tools_common = false
+do_tools_acpidbg = false
 do_zfs		= true
 do_dkms_nvidia  = true
diff --git a/debian.hwe/rules.d/arm64.mk b/debian.hwe/rules.d/arm64.mk
index c7e9a9c..de0ab473 100644
--- a/debian.hwe/rules.d/arm64.mk
+++ b/debian.hwe/rules.d/arm64.mk
@@ -12,10 +12,10 @@ loader		= grub
 vdso		= vdso_install
 
 do_extras_package = true
-do_tools_usbip  = true
-do_tools_cpupower = true
-do_tools_perf   = true
-do_tools_perf_jvmti = true
+do_tools_usbip  = false
+do_tools_cpupower = false
+do_tools_perf   = false
+do_tools_perf_jvmti = false
 
 do_dtbs		= true
 do_zfs		= true
diff --git a/debian.hwe/rules.d/armhf.mk b/debian.hwe/rules.d/armhf.mk
index d516ae1..18cd460 100644
--- a/debian.hwe/rules.d/armhf.mk
+++ b/debian.hwe/rules.d/armhf.mk
@@ -10,9 +10,9 @@ no_dumpfile	= true
 
 loader		= grub
 
-do_tools_usbip  = true
-do_tools_cpupower = true
-do_tools_perf	= true
-do_tools_perf_jvmti = true
+do_tools_usbip  = false
+do_tools_cpupower = false
+do_tools_perf	= false
+do_tools_perf_jvmti = false
 
 do_dtbs		= true
diff --git a/debian.hwe/rules.d/i386.mk b/debian.hwe/rules.d/i386.mk
index a422f9f..8bc4355 100644
--- a/debian.hwe/rules.d/i386.mk
+++ b/debian.hwe/rules.d/i386.mk
@@ -9,10 +9,10 @@ install_file	= vmlinuz
 loader		= grub
 vdso		= vdso_install
 no_dumpfile	= true
-do_tools_usbip  = true
-do_tools_cpupower = true
-do_tools_perf   = true
-do_tools_perf_jvmti = true
-do_tools_x86	= true
-do_tools_hyperv = true
+do_tools_usbip  = false
+do_tools_cpupower = false
+do_tools_perf   = false
+do_tools_perf_jvmti = false
+do_tools_x86	= false
+do_tools_hyperv = false
 do_extras_package = true
diff --git a/debian.hwe/rules.d/ppc64el.mk b/debian.hwe/rules.d/ppc64el.mk
index c540bac..c5f2c59 100644
--- a/debian.hwe/rules.d/ppc64el.mk
+++ b/debian.hwe/rules.d/ppc64el.mk
@@ -10,11 +10,11 @@ no_dumpfile	= true
 vdso		= vdso_install
 loader		= grub
 do_extras_package = true
-opal_signed       = true
-do_tools_usbip    = true
-do_tools_cpupower = true
-do_tools_perf	  = true
-do_tools_perf_jvmti = true
+opal_signed       = false
+do_tools_usbip    = false
+do_tools_cpupower = false
+do_tools_perf	  = false
+do_tools_perf_jvmti = false
 
 #do_flavour_image_package = false
 do_zfs		= true
diff --git a/debian.hwe/rules.d/s390x.mk b/debian.hwe/rules.d/s390x.mk
index dad66b1..9fd8847 100644
--- a/debian.hwe/rules.d/s390x.mk
+++ b/debian.hwe/rules.d/s390x.mk
@@ -12,9 +12,9 @@ no_dumpfile	= true
 
 do_extras_package = true
 
-do_tools_usbip    = true
-do_tools_cpupower = true
-do_tools_perf     = true
-do_tools_perf_jvmti = true
+do_tools_usbip    = false
+do_tools_cpupower = false
+do_tools_perf     = false
+do_tools_perf_jvmti = false
 
 do_zfs		= true
diff --git a/debian.hwe/rules.d/x32.mk b/debian.hwe/rules.d/x32.mk
index e0ccff9..a2833d9 100644
--- a/debian.hwe/rules.d/x32.mk
+++ b/debian.hwe/rules.d/x32.mk
@@ -9,6 +9,6 @@ install_file	= vmlinuz
 loader		= grub
 vdso		= vdso_install
 no_dumpfile	= true
-uefi_signed     = true
+uefi_signed     = false
 
 do_flavour_image_package = false
diff --git a/debian.master/rules.d/hooks.mk b/debian.master/rules.d/hooks.mk
new file mode 100644
index 0000000..a78acef
--- /dev/null
+++ b/debian.master/rules.d/hooks.mk
@@ -0,0 +1,5 @@
+do_libc_dev_package     = false
+do_doc_package          = false
+do_tools_common         = false
+do_tools_host           = false
+
diff --git a/debian/control.d/flavour-buildinfo.stub b/debian/control.d/flavour-buildinfo.stub
index ed92b3d..18505ef 100644
--- a/debian/control.d/flavour-buildinfo.stub
+++ b/debian/control.d/flavour-buildinfo.stub
@@ -1,5 +1,5 @@
 
-Package: linux-buildinfo-PKGVER-ABINUM-FLAVOUR
+Package: linux-buildinfo-mediatree-PKGVER-ABINUM-FLAVOUR
 Build-Profiles: <!stage1>
 Architecture: ARCH
 Section: kernel
diff --git a/debian/rules b/debian/rules
index 04a7181..02f1b51 100755
--- a/debian/rules
+++ b/debian/rules
@@ -35,7 +35,7 @@ include $(DROOT)/rules.d/1-maintainer.mk
 
 do_linux_tools=$(sort $(filter-out false,$(do_tools_usbip) $(do_tools_cpupower) $(do_tools_perf) $(do_tools_x86)))
 do_cloud_tools=$(sort $(filter-out false,$(do_tools_hyperv)))
-do_tools_common?=true
+do_tools_common?=false
 do_tools_host?=false
 do_tools_perf_jvmti?=false
 
diff --git a/debian/rules.d/0-common-vars.mk b/debian/rules.d/0-common-vars.mk
index adde3b7..320d68c 100644
--- a/debian/rules.d/0-common-vars.mk
+++ b/debian/rules.d/0-common-vars.mk
@@ -33,6 +33,15 @@ family=ubuntu
 # or configs.
 AUTOBUILD=
 
+skipabi         ?= true
+skipmodule      ?= true
+skipdbg         ?= true
+do_binary_udebs ?= false
+do_tools_common ?= false
+do_tools	?= false
+do_linux_tools	?= false
+skipretpoline	?= true
+
 ifneq ($(AUTOBUILD),)
 skipabi		= true
 skipmodule	= true
@@ -130,13 +139,13 @@ stampdir	:= $(CURDIR)/debian/stamps
 # are places that you'll find linux-image hard coded, but I guess thats OK since the
 # assumption that the binary package always starts with linux-image will never change.
 #
-bin_pkg_name_signed=linux-image-$(abi_release)
-bin_pkg_name_unsigned=linux-image-unsigned-$(abi_release)
-mods_pkg_name=linux-modules-$(abi_release)
-mods_extra_pkg_name=linux-modules-extra-$(abi_release)
-bldinfo_pkg_name=linux-buildinfo-$(abi_release)
-hdrs_pkg_name=linux-headers-$(abi_release)
-indep_hdrs_pkg_name=linux-headers-$(abi_release)
+bin_pkg_name_signed=linux-image-mediatree-$(abi_release)
+bin_pkg_name_unsigned=linux-image-unsigned-mediatree-$(abi_release)
+mods_pkg_name=linux-modules-mediatree-$(abi_release)
+mods_extra_pkg_name=linux-modules-extra-mediatree-$(abi_release)
+bldinfo_pkg_name=linux-buildinfo-mediatree-$(abi_release)
+hdrs_pkg_name=linux-headers-mediatree-$(abi_release)
+indep_hdrs_pkg_name=linux-headers-mediatree-$(abi_release)
 
 #
 # The generation of content in the doc package depends on both 'AUTOBUILD=' and
@@ -144,8 +153,8 @@ indep_hdrs_pkg_name=linux-headers-$(abi_release)
 # cycle, so its OK to leave 'do_doc_package_content=false' until those build
 # failures get sorted out. Finally, the doc package doesn't really need to be built
 # for developer testing (its kind of slow), so only do it if on a buildd.
-do_doc_package=true
-do_doc_package_content=true
+do_doc_package?=false
+do_doc_package_content?=true
 ifeq ($(full_build),false)
 do_doc_package_content=false
 endif
@@ -162,7 +171,7 @@ do_source_package_content=false
 endif
 
 # linux-libc-dev may not be needed, default to building it.
-do_libc_dev_package=true
+do_libc_dev_package?=false
 
 # common headers normally is built as an indep package, but may be arch
 do_common_headers_indep=true
diff --git a/debian/rules.d/2-binary-arch.mk b/debian/rules.d/2-binary-arch.mk
index 3e4c81a..474c4f8 100644
--- a/debian/rules.d/2-binary-arch.mk
+++ b/debian/rules.d/2-binary-arch.mk
@@ -744,10 +744,14 @@ build-arch: $(build-arch-deps-true)
 	@echo Debug: $@
 
 ifeq ($(AUTOBUILD),)
+ifeq ($(do_binary_udebs),true)
 binary-arch-deps-$(do_flavour_image_package) += binary-udebs
 else
 binary-arch-deps-$(do_flavour_image_package) = binary-debs
 endif
+else
+binary-arch-deps-$(do_flavour_image_package) = binary-debs
+endif
 binary-arch-deps-$(do_libc_dev_package) += binary-arch-headers
 ifneq ($(do_common_headers_indep),true)
 binary-arch-deps-$(do_flavour_header_package) += binary-headers
diff --git a/debian/scripts/dkms-build b/debian/scripts/dkms-build
index 6457d36..53b4e1b 100755
--- a/debian/scripts/dkms-build
+++ b/debian/scripts/dkms-build
@@ -121,7 +121,7 @@ rc=0
 	-k "$abi_flavour" \
 	--sourcetree "$dkms_dir/source" \
 	--dkmstree "$dkms_dir/build" \
-	--kernelsourcedir "$dkms_dir/headers/linux-headers-$abi_flavour" \
+	--kernelsourcedir "$dkms_dir/headers/linux-headers-mediatree-$abi_flavour" \
 	"$dkms_conf" || rc=1
 
 # Find the log and add it to our own.
-- 
2.7.4

