From 138e1ca4f417a58fe0196b862e3535b7e9f7d935 Mon Sep 17 00:00:00 2001
From: Brad Love <hidden@email.co>
Date: Sat, 7 Oct 2017 14:38:38 -0500
Subject: [PATCH 2/6] Apply build fixes to media tree

---
 drivers/media/cec/cec-api.c                       | 2 ++
 drivers/media/cec/cec-core.c                      | 2 ++
 drivers/media/dvb-frontends/af9033.c              | 2 ++
 drivers/media/media-device.c                      | 2 ++
 drivers/media/media-devnode.c                     | 2 ++
 drivers/media/pci/ivtv/ivtv-driver.c              | 2 ++
 drivers/media/pci/ivtv/ivtv-irq.c                 | 2 ++
 drivers/media/pci/zoran/zoran_card.c              | 2 ++
 drivers/media/radio/wl128x/fmdrv_common.c         | 2 +-
 drivers/media/rc/keymaps/rc-cec.c                 | 2 ++
 drivers/media/rc/serial_ir.c                      | 2 ++
 drivers/media/rc/sir_ir.c                         | 2 ++
 drivers/media/usb/em28xx/em28xx-dvb.c             | 2 +-
 drivers/media/usb/pulse8-cec/pulse8-cec.c         | 2 ++
 drivers/media/usb/rainshadow-cec/rainshadow-cec.c | 2 ++
 drivers/media/usb/usbtv/usbtv-core.c              | 2 ++
 drivers/media/usb/uvc/uvc_driver.c                | 2 ++
 drivers/media/usb/uvc/uvc_video.c                 | 2 ++
 drivers/media/v4l2-core/v4l2-async.c              | 2 ++
 drivers/media/v4l2-core/v4l2-flash-led-class.c    | 2 ++
 drivers/media/v4l2-core/v4l2-ioctl.c              | 2 ++
 drivers/media/v4l2-core/videobuf2-dma-contig.c    | 4 ++--
 drivers/media/v4l2-core/videobuf2-dma-sg.c        | 6 ++++--
 drivers/media/v4l2-core/videobuf2-vmalloc.c       | 4 ++--
 include/media/compat.h                            | 6 +++---
 include/media/media-entity.h                      | 2 ++
 include/media/v4l2-fwnode.h                       | 2 ++
 27 files changed, 55 insertions(+), 11 deletions(-)

diff --git a/drivers/media/cec/cec-api.c b/drivers/media/cec/cec-api.c
index 8ac616d2927b..af34e23e53b5 100644
--- a/drivers/media/cec/cec-api.c
+++ b/drivers/media/cec/cec-api.c
@@ -30,6 +30,8 @@
 #include <linux/uaccess.h>
 #include <linux/version.h>
 
+#include <media/compat.h>
+
 #include <media/cec-pin.h>
 #include "cec-priv.h"
 
diff --git a/drivers/media/cec/cec-core.c b/drivers/media/cec/cec-core.c
index e3a1fb6d6690..ea04c2288663 100644
--- a/drivers/media/cec/cec-core.c
+++ b/drivers/media/cec/cec-core.c
@@ -29,6 +29,8 @@
 
 #include "cec-priv.h"
 
+#include <media/compat.h>
+
 #define CEC_NUM_DEVICES	256
 #define CEC_NAME	"cec"
 
diff --git a/drivers/media/dvb-frontends/af9033.c b/drivers/media/dvb-frontends/af9033.c
index aaed7cfe5f66..1631b9a9385a 100644
--- a/drivers/media/dvb-frontends/af9033.c
+++ b/drivers/media/dvb-frontends/af9033.c
@@ -15,6 +15,8 @@
  *    GNU General Public License for more details.
  */
 
+#include <media/compat.h>
+
 #include "af9033_priv.h"
 
 struct af9033_dev {
diff --git a/drivers/media/media-device.c b/drivers/media/media-device.c
index 77c2abad24b7..080e5c038b3b 100644
--- a/drivers/media/media-device.c
+++ b/drivers/media/media-device.c
@@ -33,6 +33,8 @@
 #include <media/media-devnode.h>
 #include <media/media-entity.h>
 
+#include <media/compat.h>
+
 #ifdef CONFIG_MEDIA_CONTROLLER
 
 /* -----------------------------------------------------------------------------
diff --git a/drivers/media/media-devnode.c b/drivers/media/media-devnode.c
index 06bf97d61b42..ec2b6cb5fd0b 100644
--- a/drivers/media/media-devnode.c
+++ b/drivers/media/media-devnode.c
@@ -43,6 +43,8 @@
 #include <media/media-devnode.h>
 #include <media/media-device.h>
 
+#include <media/compat.h>
+
 #define MEDIA_NUM_DEVICES	256
 #define MEDIA_NAME		"media"
 
diff --git a/drivers/media/pci/ivtv/ivtv-driver.c b/drivers/media/pci/ivtv/ivtv-driver.c
index 1892d4ef9d88..8c478e65e57a 100644
--- a/drivers/media/pci/ivtv/ivtv-driver.c
+++ b/drivers/media/pci/ivtv/ivtv-driver.c
@@ -60,6 +60,8 @@
 #include <media/i2c/saa7115.h>
 #include "tuner-xc2028.h"
 
+#include <media/compat.h>
+
 /* If you have already X v4l cards, then set this to X. This way
    the device numbers stay matched. Example: you have a WinTV card
    without radio and a PVR-350 with. Normally this would give a
diff --git a/drivers/media/pci/ivtv/ivtv-irq.c b/drivers/media/pci/ivtv/ivtv-irq.c
index 6efe1f71262c..93153d8ba074 100644
--- a/drivers/media/pci/ivtv/ivtv-irq.c
+++ b/drivers/media/pci/ivtv/ivtv-irq.c
@@ -27,6 +27,8 @@
 #include "ivtv-yuv.h"
 #include <media/v4l2-event.h>
 
+#include <media/compat.h>
+
 #define DMA_MAGIC_COOKIE 0x000001fe
 
 static void ivtv_dma_dec_start(struct ivtv_stream *s);
diff --git a/drivers/media/pci/zoran/zoran_card.c b/drivers/media/pci/zoran/zoran_card.c
index a6b9ebd20263..ed6c2cee26af 100644
--- a/drivers/media/pci/zoran/zoran_card.c
+++ b/drivers/media/pci/zoran/zoran_card.c
@@ -54,6 +54,8 @@
 #include "zoran_device.h"
 #include "zoran_procfs.h"
 
+#include <media/compat.h>
+
 extern const struct zoran_format zoran_formats[];
 
 static int card[BUZ_MAX] = { [0 ... (BUZ_MAX-1)] = -1 };
diff --git a/drivers/media/radio/wl128x/fmdrv_common.c b/drivers/media/radio/wl128x/fmdrv_common.c
index ab3428bf63fe..2a4ee5f34661 100644
--- a/drivers/media/radio/wl128x/fmdrv_common.c
+++ b/drivers/media/radio/wl128x/fmdrv_common.c
@@ -416,7 +416,7 @@ static int fm_send_cmd(struct fmdev *fmdev, u8 fm_op, u16 type,	void *payload,
 	if (!test_bit(FM_FW_DW_INPROGRESS, &fmdev->flag) ||
 			test_bit(FM_INTTASK_RUNNING, &fmdev->flag)) {
 		/* Fill command header info */
-		hdr = skb_put(skb, FM_CMD_MSG_HDR_SIZE);
+		hdr = (void*)skb_put(skb, FM_CMD_MSG_HDR_SIZE);
 		hdr->hdr = FM_PKT_LOGICAL_CHAN_NUMBER;	/* 0x08 */
 
 		/* 3 (fm_opcode,rd_wr,dlen) + payload len) */
diff --git a/drivers/media/rc/keymaps/rc-cec.c b/drivers/media/rc/keymaps/rc-cec.c
index 76d34abb7c85..5da1c05b924d 100644
--- a/drivers/media/rc/keymaps/rc-cec.c
+++ b/drivers/media/rc/keymaps/rc-cec.c
@@ -11,6 +11,8 @@
 #include <media/rc-map.h>
 #include <linux/module.h>
 
+#include <media/compat.h>
+
 /*
  * CEC Spec "High-Definition Multimedia Interface Specification" can be obtained
  * here: http://xtreamerdev.googlecode.com/files/CEC_Specs.pdf
diff --git a/drivers/media/rc/serial_ir.c b/drivers/media/rc/serial_ir.c
index b2cdf4b89439..28fe915683e2 100644
--- a/drivers/media/rc/serial_ir.c
+++ b/drivers/media/rc/serial_ir.c
@@ -35,6 +35,8 @@
 #include <linux/spinlock.h>
 #include <media/rc-core.h>
 
+#include <media/compat.h>
+
 struct serial_ir_hw {
 	int signal_pin;
 	int signal_pin_change;
diff --git a/drivers/media/rc/sir_ir.c b/drivers/media/rc/sir_ir.c
index 9769bf7b4172..7d42ab734e8d 100644
--- a/drivers/media/rc/sir_ir.c
+++ b/drivers/media/rc/sir_ir.c
@@ -23,6 +23,8 @@
 
 #include <media/rc-core.h>
 
+#include <media/compat.h>
+
 /* SECTION: Definitions */
 #define PULSE '['
 
diff --git a/drivers/media/usb/em28xx/em28xx-dvb.c b/drivers/media/usb/em28xx/em28xx-dvb.c
index 5b01ff520b82..d46fc1108cf9 100644
--- a/drivers/media/usb/em28xx/em28xx-dvb.c
+++ b/drivers/media/usb/em28xx/em28xx-dvb.c
@@ -44,7 +44,7 @@
 #include "mt352.h"
 #include "mt352_priv.h" /* FIXME */
 #include "tda1002x.h"
-#include "drx39xxj.h"
+#include "../../dvb-frontends/drx39xyj/drx39xxj.h"
 #include "tda18271.h"
 #include "s921.h"
 #include "drxd.h"
diff --git a/drivers/media/usb/pulse8-cec/pulse8-cec.c b/drivers/media/usb/pulse8-cec/pulse8-cec.c
index 50146f263d90..9c29620291bc 100644
--- a/drivers/media/usb/pulse8-cec/pulse8-cec.c
+++ b/drivers/media/usb/pulse8-cec/pulse8-cec.c
@@ -44,6 +44,8 @@
 #include <linux/time.h>
 #include <linux/delay.h>
 
+#include <media/compat.h>
+
 #include <media/cec.h>
 
 MODULE_AUTHOR("Hans Verkuil <hverkuil@xs4all.nl>");
diff --git a/drivers/media/usb/rainshadow-cec/rainshadow-cec.c b/drivers/media/usb/rainshadow-cec/rainshadow-cec.c
index cecdcbcd400c..83aeece6b871 100644
--- a/drivers/media/usb/rainshadow-cec/rainshadow-cec.c
+++ b/drivers/media/usb/rainshadow-cec/rainshadow-cec.c
@@ -34,6 +34,8 @@
 #include <linux/time.h>
 #include <linux/workqueue.h>
 
+#include <media/compat.h>
+
 #include <media/cec.h>
 
 MODULE_AUTHOR("Hans Verkuil <hverkuil@xs4all.nl>");
diff --git a/drivers/media/usb/usbtv/usbtv-core.c b/drivers/media/usb/usbtv/usbtv-core.c
index f06f09a0876e..ef18c8d28ad9 100644
--- a/drivers/media/usb/usbtv/usbtv-core.c
+++ b/drivers/media/usb/usbtv/usbtv-core.c
@@ -44,6 +44,8 @@
 
 #include "usbtv.h"
 
+#include <media/compat.h>
+
 int usbtv_set_regs(struct usbtv *usbtv, const u16 regs[][2], int size)
 {
 	int ret;
diff --git a/drivers/media/usb/uvc/uvc_driver.c b/drivers/media/usb/uvc/uvc_driver.c
index 6d22b22cb35b..5c0055f15fd8 100644
--- a/drivers/media/usb/uvc/uvc_driver.c
+++ b/drivers/media/usb/uvc/uvc_driver.c
@@ -27,6 +27,8 @@
 
 #include "uvcvideo.h"
 
+#include <media/compat.h>
+
 #define DRIVER_AUTHOR		"Laurent Pinchart " \
 				"<laurent.pinchart@ideasonboard.com>"
 #define DRIVER_DESC		"USB Video Class driver"
diff --git a/drivers/media/usb/uvc/uvc_video.c b/drivers/media/usb/uvc/uvc_video.c
index fb86d6af398d..635ffa82b30a 100644
--- a/drivers/media/usb/uvc/uvc_video.c
+++ b/drivers/media/usb/uvc/uvc_video.c
@@ -26,6 +26,8 @@
 
 #include "uvcvideo.h"
 
+#include <media/compat.h>
+
 /* ------------------------------------------------------------------------
  * UVC Controls
  */
diff --git a/drivers/media/v4l2-core/v4l2-async.c b/drivers/media/v4l2-core/v4l2-async.c
index d741a8e0fdac..11f15ca2b4a9 100644
--- a/drivers/media/v4l2-core/v4l2-async.c
+++ b/drivers/media/v4l2-core/v4l2-async.c
@@ -24,6 +24,8 @@
 #include <media/v4l2-device.h>
 #include <media/v4l2-subdev.h>
 
+#include <media/compat.h>
+
 static bool match_i2c(struct v4l2_subdev *sd, struct v4l2_async_subdev *asd)
 {
 #if IS_ENABLED(CONFIG_I2C)
diff --git a/drivers/media/v4l2-core/v4l2-flash-led-class.c b/drivers/media/v4l2-core/v4l2-flash-led-class.c
index 4ceef217de83..e609bf054f67 100644
--- a/drivers/media/v4l2-core/v4l2-flash-led-class.c
+++ b/drivers/media/v4l2-core/v4l2-flash-led-class.c
@@ -17,6 +17,8 @@
 #include <linux/types.h>
 #include <media/v4l2-flash-led-class.h>
 
+#include <media/compat.h>
+
 #define has_flash_op(v4l2_flash, op)				\
 	(v4l2_flash && v4l2_flash->ops && v4l2_flash->ops->op)
 
diff --git a/drivers/media/v4l2-core/v4l2-ioctl.c b/drivers/media/v4l2-core/v4l2-ioctl.c
index fc2453c41dea..0349c94bb9da 100644
--- a/drivers/media/v4l2-core/v4l2-ioctl.c
+++ b/drivers/media/v4l2-core/v4l2-ioctl.c
@@ -32,6 +32,8 @@
 
 #include <trace/events/v4l2.h>
 
+#include <media/compat.h>
+
 /* Zero out the end of the struct pointed to by p.  Everything after, but
  * not including, the specified field is cleared. */
 #define CLEAR_AFTER_FIELD(p, field) \
diff --git a/drivers/media/v4l2-core/videobuf2-dma-contig.c b/drivers/media/v4l2-core/videobuf2-dma-contig.c
index 1b523f7c1e5a..7e1a13fa8d67 100644
--- a/drivers/media/v4l2-core/videobuf2-dma-contig.c
+++ b/drivers/media/v4l2-core/videobuf2-dma-contig.c
@@ -356,8 +356,8 @@ static const struct dma_buf_ops vb2_dc_dmabuf_ops = {
 	.detach = vb2_dc_dmabuf_ops_detach,
 	.map_dma_buf = vb2_dc_dmabuf_ops_map,
 	.unmap_dma_buf = vb2_dc_dmabuf_ops_unmap,
-	.map = vb2_dc_dmabuf_ops_kmap,
-	.map_atomic = vb2_dc_dmabuf_ops_kmap,
+	.kmap = vb2_dc_dmabuf_ops_kmap,
+	.kmap_atomic = vb2_dc_dmabuf_ops_kmap,
 	.vmap = vb2_dc_dmabuf_ops_vmap,
 	.mmap = vb2_dc_dmabuf_ops_mmap,
 	.release = vb2_dc_dmabuf_ops_release,
diff --git a/drivers/media/v4l2-core/videobuf2-dma-sg.c b/drivers/media/v4l2-core/videobuf2-dma-sg.c
index a8198447f7a6..32bc67066383 100644
--- a/drivers/media/v4l2-core/videobuf2-dma-sg.c
+++ b/drivers/media/v4l2-core/videobuf2-dma-sg.c
@@ -21,6 +21,8 @@
 #include <media/videobuf2-memops.h>
 #include <media/videobuf2-dma-sg.h>
 
+#include <media/compat.h>
+
 static int debug;
 module_param(debug, int, 0644);
 
@@ -506,8 +508,8 @@ static const struct dma_buf_ops vb2_dma_sg_dmabuf_ops = {
 	.detach = vb2_dma_sg_dmabuf_ops_detach,
 	.map_dma_buf = vb2_dma_sg_dmabuf_ops_map,
 	.unmap_dma_buf = vb2_dma_sg_dmabuf_ops_unmap,
-	.map = vb2_dma_sg_dmabuf_ops_kmap,
-	.map_atomic = vb2_dma_sg_dmabuf_ops_kmap,
+	.kmap = vb2_dma_sg_dmabuf_ops_kmap,
+	.kmap_atomic = vb2_dma_sg_dmabuf_ops_kmap,
 	.vmap = vb2_dma_sg_dmabuf_ops_vmap,
 	.mmap = vb2_dma_sg_dmabuf_ops_mmap,
 	.release = vb2_dma_sg_dmabuf_ops_release,
diff --git a/drivers/media/v4l2-core/videobuf2-vmalloc.c b/drivers/media/v4l2-core/videobuf2-vmalloc.c
index 5aae15b41437..2f01047984d8 100644
--- a/drivers/media/v4l2-core/videobuf2-vmalloc.c
+++ b/drivers/media/v4l2-core/videobuf2-vmalloc.c
@@ -344,8 +344,8 @@ static const struct dma_buf_ops vb2_vmalloc_dmabuf_ops = {
 	.detach = vb2_vmalloc_dmabuf_ops_detach,
 	.map_dma_buf = vb2_vmalloc_dmabuf_ops_map,
 	.unmap_dma_buf = vb2_vmalloc_dmabuf_ops_unmap,
-	.map = vb2_vmalloc_dmabuf_ops_kmap,
-	.map_atomic = vb2_vmalloc_dmabuf_ops_kmap,
+	.kmap = vb2_vmalloc_dmabuf_ops_kmap,
+	.kmap_atomic = vb2_vmalloc_dmabuf_ops_kmap,
 	.vmap = vb2_vmalloc_dmabuf_ops_vmap,
 	.mmap = vb2_vmalloc_dmabuf_ops_mmap,
 	.release = vb2_vmalloc_dmabuf_ops_release,
diff --git a/include/media/compat.h b/include/media/compat.h
index 58dcb88e07b2..17a5a5a9a1d2 100644
--- a/include/media/compat.h
+++ b/include/media/compat.h
@@ -2058,9 +2058,9 @@ static inline void fwnode_handle_get(struct fwnode_handle *fwnode)
 {
 }
 
-static inline void fwnode_handle_put(struct fwnode_handle *fwnode)
-{
-}
+//static inline void fwnode_handle_put(struct fwnode_handle *fwnode)
+//{
+//}
 
 #endif
 
diff --git a/include/media/media-entity.h b/include/media/media-entity.h
index 222d379960b7..906a82c8f50f 100644
--- a/include/media/media-entity.h
+++ b/include/media/media-entity.h
@@ -26,6 +26,8 @@
 #include <linux/list.h>
 #include <linux/media.h>
 
+#include <media/compat.h>
+
 /* Enums used internally at the media controller to represent graphs */
 
 /**
diff --git a/include/media/v4l2-fwnode.h b/include/media/v4l2-fwnode.h
index 7adec9851d9e..a8f79048b444 100644
--- a/include/media/v4l2-fwnode.h
+++ b/include/media/v4l2-fwnode.h
@@ -24,6 +24,8 @@
 
 #include <media/v4l2-mediabus.h>
 
+#include <media/compat.h>
+
 struct fwnode_handle;
 
 #define V4L2_FWNODE_CSI2_MAX_DATA_LANES	4
-- 
2.11.0

